name: Build for Raspberry Pi Zero 2W

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  build-cross-compile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install ARM cross-compilation toolchain
      run: |
        sudo apt update
        sudo apt install -y \
          gcc-arm-linux-gnueabihf \
          g++-arm-linux-gnueabihf \
          cmake \
          git \
          autoconf \
          automake \
          libtool

    - name: Create simple ARM toolchain file
      run: |
        cat > /tmp/arm-toolchain-simple.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR arm)
        set(CMAKE_C_COMPILER arm-linux-gnueabihf-gcc)
        set(CMAKE_CXX_COMPILER arm-linux-gnueabihf-g++)
        EOF

    - name: Cross-compile spdlog library
      run: |
        cd /tmp
        git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git
        cd spdlog
        mkdir build && cd build

        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../../arm-toolchain-simple.cmake \
          -DCMAKE_INSTALL_PREFIX=/tmp/arm-sysroot \
          -DSPDLOG_BUILD_SHARED=OFF \
          -DSPDLOG_BUILD_EXAMPLE=OFF \
          -DSPDLOG_BUILD_TESTS=OFF

        make -j$(nproc)
        make install

    - name: Cross-compile BCM2835 library
      run: |
        cd /tmp
        # Use GitHub mirror (more reliable than airspayce.com)
        git clone https://github.com/smart-facility/bcm2835.git
        cd bcm2835
        autoreconf -fi

        # Cross-compile for ARM
        ./configure \
          --host=arm-linux-gnueabihf \
          CC=arm-linux-gnueabihf-gcc \
          AR=arm-linux-gnueabihf-ar \
          --prefix=/tmp/arm-sysroot

        make
        make install

    - name: Create CMake toolchain file
      run: |
        cat > arm-toolchain.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR arm)

        set(CMAKE_C_COMPILER arm-linux-gnueabihf-gcc)
        set(CMAKE_CXX_COMPILER arm-linux-gnueabihf-g++)

        set(CMAKE_FIND_ROOT_PATH /tmp/arm-sysroot)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

        # Force RPI mode
        add_definitions(-DRPI -DUSE_BCM2835_LIB)
        EOF

    - name: Build project
      run: |
        mkdir -p build
        cd build
        cmake \
          -DCMAKE_TOOLCHAIN_FILE=../arm-toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          ..
        make -j$(nproc)

    - name: Verify ARM binary
      run: |
        file build/pocket-term
        arm-linux-gnueabihf-readelf -h build/pocket-term | grep Machine

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pocket-term-rpi-zero-2w
        path: build/pocket-term
        retention-days: 30
